@isTest
private class DeploymentChecklistTest {
    static final String MAPPING_JSON_COMPLETE = '{"recommended":[{"mappingData":[{"destination":"Account","fieldMapping":[{"source":"MasterRecordId","destination":"MasterRecordId","userGenerated":"true"},{"source":"LastName","destination":"LastName","userGenerated":"true"},{"source":"FirstName","destination":"FirstName","userGenerated":"true"},{"source":"Salutation","destination":"Salutation","userGenerated":"true"},{"source":"IndividualId","destination":"PersonIndividualId","userGenerated":"true"}],"recordTypeMapping":[{"userGenerated":"true","destination":"PersonAccount","source":"Master"}],"showDetails":true,"source":"Contact"}],"sectionName":"People (B2C)"},{"mappingData":[{"destination":"FinServ__FinancialAccount__c","fieldMapping":[{"source":"OwnerId","destination":"OwnerId","userGenerated":"true"},{"source":"Name","destination":"Name","userGenerated":"true"},{"source":"CreatedDate","destination":"CreatedDate","userGenerated":"true"},{"source":"CreatedById","destination":"CreatedById","userGenerated":"true"},{"source":"LastModifiedDate","destination":"LastModifiedDate","userGenerated":"true"},{"source":"LastModifiedById","destination":"LastModifiedById","userGenerated":"true"},{"source":"Status__c","destination":"FinServ__Status__c","userGenerated":"true"},{"destination":"Sub_Status","source":"Sub_Status__c","truncate":"false","userGenerated":"true","newMeta":{"label":"Sub Status","apiName":"Sub_Status","description":"","dataType":"text","helpText":"","length":"25"}}],"recordTypeMapping":[{"source":"Master","destination":"InvestmentAccount","userGenerated":"true"},{"destination":"IRA","source":"Master","truncate":"false","userGenerated":"true","newMeta":{"label":"IRA","apiName":"IRA","description":"IRAs","active":false}},{"destination":"Brokerage","source":"Master","truncate":"false","userGenerated":"true","newMeta":{"label":"Brokerage","apiName":"Brokerage","description":"Brokerage accounts","active":false}}],"showDetails":true,"source":"Assessment__c"},{"destination":"FinServ__FinancialAccountRole__c","fieldMapping":[],"recordTypeMapping":[],"source":""}],"sectionName":"Not Listed"}],"additional":[]}';
    static final String ANALYSIS_JSON_COMPLETE = '{"migrationAnalysis":[{"toComponentName":"FinServ__FinancialAccount__c","fromComponentType":"CustomObject","fromComponentId":"01I4x000000VYCnEAO","fromComponentName":"Assessment","children":[{"fromComponentType":"CompactLayout","fromComponentName":"Compact Layout (1)","children":[{"fromComponentType":"CompactLayout","fromComponentId":"0AH4x000001GwftGAC","fromComponentName":"Test_Compact_INGORE","children":[]}]},{"fromComponentType":"FieldSet","fromComponentName":"Field Set (1)","children":[{"fromComponentType":"FieldSet","fromComponentId":"0IX4x0000004YxbGAE","fromComponentName":"Test_IGNORE","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuR3VEAV","fromComponentName":"Bulk_Scan_Complete","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KlmzQEAR","fromComponentName":"Financial_Accounts_Leveraged","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foK3EAI","fromComponentName":"Is_B2C","children":[]}]}]},{"fromComponentType":"FlexiPage","fromComponentName":"Lightning Page (1)","children":[{"fromComponentType":"FlexiPage","fromComponentId":"0M04x000002KVefCAG","fromComponentName":"Assessment_Record_Page","children":[{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmULAA1","fromComponentName":"UIAssessmentPageTabChecklist","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUQAA1","fromComponentName":"UIAssessmentPageTabDeploy","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUGAA1","fromComponentName":"UIAssessmentPageTabInstall","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUBAA1","fromComponentName":"UIAssessmentPageTabReport","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUVAA1","fromComponentName":"UIAssessmentPageTabRollout","children":[]},{"fromComponentType":"LightningComponentBundle","fromComponentId":"0Rb4x0000001pctCAA","fromComponentName":"assessmentResults","children":[]},{"fromComponentType":"LightningComponentBundle","fromComponentId":"0Rb4x0000003x9OCAQ","fromComponentName":"deploymentChecklist","children":[]},{"fromComponentType":"LightningComponentBundle","fromComponentId":"0Rb4x0000003xDkCAI","fromComponentName":"packageScreen","children":[]}]}]},{"fromComponentType":"RecordType","fromComponentName":"Record Type (1)","children":[{"toComponentName":"Brokerage","fromComponentType":"RecordType","fromComponentName":"Master","children":[]}]},{"fromComponentType":"ReportType","fromComponentName":"Report Type (1)","children":[{"fromComponentType":"ReportType","fromComponentId":"0704x000000Ls70AAC","fromComponentName":"Test_Report_Type","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foKNEAY","fromComponentName":"AnalysisDataJSON","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Q659AEAR","fromComponentName":"Apex_Sharing_Scan_Complete","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuR3VEAV","fromComponentName":"Bulk_Scan_Complete","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KkwJKEAZ","fromComponentName":"Current_Question_Id","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KkwJPEAZ","fromComponentName":"Current_Question_Number","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Du46tEAB","fromComponentName":"Customer_Representation","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Dx1j8EAB","fromComponentName":"External_Data_In_Salesforce","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KlmzQEAR","fromComponentName":"Financial_Accounts_Leveraged","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Q65CxEAJ","fromComponentName":"HasMappingData","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Q5rviEAB","fromComponentName":"Has_Apex_Sharing","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foK8EAI","fromComponentName":"Has_Relationship_Groups","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuM0jEAF","fromComponentName":"Has_Rollups","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foK3EAI","fromComponentName":"Is_B2C","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foKIEAY","fromComponentName":"MappingDataJSON","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuM0ZEAV","fromComponentName":"Relationship_Groupings","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foJzEAI","fromComponentName":"Selected_Products","children":[]},{"toComponentName":"FinServ__Status__c","fromComponentType":"CustomField","fromComponentId":"00N4x000007foJFEAY","fromComponentName":"Status","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foKDEAY","fromComponentName":"Upgrade_Recommendation","children":[]}]}]}]},{"toComponentName":"Account","fromComponentType":"StandardEntity","fromComponentId":"Contact","fromComponentName":"Contact","children":[{"fromComponentType":"FieldSet","fromComponentName":"Field Set (1)","children":[{"fromComponentType":"FieldSet","fromComponentId":"0IX4x0000004YxgGAE","fromComponentName":"Contact_FieldSet_Test","children":[]}]},{"fromComponentType":"Layout","fromComponentName":"Page Layout (4)","children":[{"fromComponentType":"Layout","fromComponentId":"00h4x000003wltyAAA","fromComponentName":"Contact (Marketing) Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]},{"fromComponentType":"Layout","fromComponentId":"00h4x000003wltzAAA","fromComponentName":"Contact (Sales) Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]},{"fromComponentType":"Layout","fromComponentId":"00h4x000003wlu0AAA","fromComponentName":"Contact (Support) Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]},{"fromComponentType":"Layout","fromComponentId":"00h4x000003wlu1AAA","fromComponentName":"Contact Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]}]},{"fromComponentType":"ListView","fromComponentName":"List View (6)","children":[{"fromComponentType":"ListView","fromComponentId":"00B4x000006hcwgEAA","fromComponentName":"All Contacts","children":[]},{"fromComponentType":"ListView","fromComponentId":"00B4x000006hcw9EAA","fromComponentName":"Birthdays This Month","children":[]}]},{"fromComponentType":"RecordType","fromComponentName":"Record Type (1)","children":[{"toComponentName":"PersonAccount","fromComponentType":"RecordType","fromComponentName":"Master","children":[]}]}]}],"accessInfoResults":[{"uuid":"4c0a40a1-26c9-7efb-3eba-81bfa6391f88","toComponentName":null,"reasonText":"0","fromComponentType":"Profile","fromComponentId":"00e4x000001ngr5AAA","fromComponentName":"Custom: Marketing Profile","children":[]}]}';
    static final String ASSESSMENT_STATUS_REVIEW = 'Review';

    static testMethod void testGenerateDeploymentList_Success() {
        Assessment__c assessment = new Assessment__c(MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;
        TransitionAnalysis.saveAnalysis(assessment.Id, (TransitionAnalysis)JSON.deserialize(ANALYSIS_JSON_COMPLETE, TransitionAnalysis.class));

        Test.startTest();
            List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);
        Test.stopTest();

        System.assertNotEquals(null, deploymentList, 'List should be generated with DeploymentChecklistSection type');
    }

    static testMethod void testSaveDeploymentChecklist_Success() {
        Assessment__c assessment = new Assessment__c(MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;
        List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);

        Test.startTest();
            Id fileId = DeploymentChecklist.saveDeploymentChecklist(assessment.Id, JSON.serialize(deploymentList));
        Test.stopTest();

        System.assertNotEquals(null, fileId, 'Expecting fileId to be generated after file save');
    }

    static testMethod void testGenerateDeploymentPackage_Success() {
        Assessment__c assessment = new Assessment__c(Status__c=ASSESSMENT_STATUS_REVIEW, MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;
        List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);
        Id fileId = DeploymentChecklist.saveDeploymentChecklist(assessment.Id, JSON.serialize(deploymentList));

        Test.setMock(HttpCalloutMock.class, new MockResponse(ExternalUtilities.HTTP_RESPONSE_CODE_PROCESSING, 'ok'));
        Test.startTest();
            Boolean isSuccess = DeploymentChecklist.generateDeploymentPackage(assessment.Id, fileId);
        Test.stopTest();

        System.assertEquals(true, isSuccess, 'Expecting true after API callout response');
    }

    static testMethod void testGenerateDeploymentPackage_CalloutFail() {
        Assessment__c assessment = new Assessment__c(MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;
        List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);
        Id fileId = DeploymentChecklist.saveDeploymentChecklist(assessment.Id, JSON.serialize(deploymentList));

        Test.setMock(HttpCalloutMock.class, new MockResponse(ExternalUtilities.HTTP_RESPONSE_CODE_FAILURE, 'fail'));
        Test.startTest();
            Boolean isSuccess = DeploymentChecklist.generateDeploymentPackage(assessment.Id, fileId);
        Test.stopTest();

        System.assertEquals(false, isSuccess, 'Expecting false after failed API callout response');
    }
}